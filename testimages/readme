Chá»§ Ä‘á»: Backfill áº£nh Google Maps báº±ng Selenium
ğŸ§  1. Giá»›i thiá»‡u tá»•ng quan

Xin chÃ o,
hÃ´m nay mÃ¬nh sáº½ giá»›i thiá»‡u script tá»± Ä‘á»™ng láº¥y áº£nh tá»« Google Maps vÃ  cáº­p nháº­t vÃ o cÆ¡ sá»Ÿ dá»¯ liá»‡u PostgreSQL.
TÃªn file lÃ  fetch_gmaps_photos_selenium.py.

ğŸ§© Má»¥c tiÃªu:

HoÃ n thiá»‡n dá»¯ liá»‡u hÃ¬nh áº£nh cho cÃ¡c cá»­a hÃ ng trong báº£ng grocery_stores.

Tá»± Ä‘á»™ng hÃ³a hoÃ n toÃ n: khÃ´ng cáº§n thá»§ cÃ´ng má»Ÿ tá»«ng Ä‘á»‹a Ä‘iá»ƒm trÃªn Google Maps.

KhÃ´ng tá»‘n phÃ­ API â€” vÃ¬ khÃ´ng dÃ¹ng Google Places API mÃ  láº¥y trá»±c tiáº¿p tá»« trang web.

ğŸ“¥ Dá»¯ liá»‡u Ä‘áº§u vÃ o:

Má»—i cá»­a hÃ ng trong báº£ng grocery_stores cÃ³ má»™t trÆ°á»ng place_id (ID cá»§a Ä‘á»‹a Ä‘iá»ƒm trÃªn Google Maps).

ğŸ“¤ Káº¿t quáº£ Ä‘áº§u ra:

Cá»™t image trong báº£ng sáº½ Ä‘Æ°á»£c cáº­p nháº­t báº±ng URL áº£nh chÃ­nh cá»§a Ä‘á»‹a Ä‘iá»ƒm Ä‘Ã³, vÃ­ dá»¥:

https://lh3.googleusercontent.com/p/AF1QipOaA4s...

âš ï¸ LÆ°u Ã½ quan trá»ng:

Viá»‡c â€œcÃ oâ€ dá»¯ liá»‡u (scraping) tá»« Google Maps cÃ³ thá»ƒ vi pháº¡m Ä‘iá»u khoáº£n dá»‹ch vá»¥ cá»§a Google.
ğŸ‘‰ VÃ¬ váº­y, chá»‰ nÃªn dÃ¹ng cho má»¥c Ä‘Ã­ch há»c táº­p, nghiÃªn cá»©u, hoáº·c ná»™i bá»™.
KhÃ´ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ thu tháº­p hÃ ng loáº¡t dá»¯ liá»‡u thÆ°Æ¡ng máº¡i.

âš™ï¸ 2. MÃ´i trÆ°á»ng & yÃªu cáº§u cÃ i Ä‘áº·t
Cáº§n cÃ³:

Python 3.9 trá»Ÿ lÃªn

Google Chrome hoáº·c Chromium

PostgreSQL (Ä‘á»ƒ lÆ°u áº£nh)

CÃ i thÆ° viá»‡n cáº§n thiáº¿t:

Má»Ÿ Terminal vÃ  cháº¡y:

pip install undetected-chromedriver selenium psycopg2-binary python-dotenv


undetected-chromedriver: giÃºp Selenium trÃ¡nh bá»‹ Google phÃ¡t hiá»‡n lÃ  bot.

selenium: Ä‘iá»u khiá»ƒn trÃ¬nh duyá»‡t tá»± Ä‘á»™ng.

psycopg2-binary: káº¿t ná»‘i tá»›i PostgreSQL.

python-dotenv: Ä‘á»c thÃ´ng tin cáº¥u hÃ¬nh tá»« file .env.

ğŸ§¾ 3. Cáº¥u hÃ¬nh file .env

Táº¡o file .env trong thÆ° má»¥c chá»©a script Ä‘á»ƒ khai bÃ¡o thÃ´ng tin káº¿t ná»‘i database vÃ  cÃ i Ä‘áº·t Chrome.

CÃ¡ch A â€“ dÃ¹ng cÃ¡c biáº¿n PG riÃªng láº»:
PGHOST=localhost
PGPORT=5432
PGDATABASE=gisdb
PGUSER=postgres
PGPASSWORD=12345

# Cáº¥u hÃ¬nh Selenium
SELENIUM_HEADLESS=true
SELENIUM_WINDOW=1200x900

CÃ¡ch B â€“ dÃ¹ng DATABASE_URL (ngáº¯n gá»n hÆ¡n):
DATABASE_URL=postgresql://postgres:12345@localhost:5432/gisdb
SELENIUM_HEADLESS=true
SELENIUM_WINDOW=1200x900


ğŸ’¡ Náº¿u cáº£ hai cÃ¹ng cÃ³, script Æ°u tiÃªn DATABASE_URL.

â–¶ï¸ 4. CÃ¡ch cháº¡y script

VÃ­ dá»¥:

python fetch_gmaps_photos_selenium.py --limit 200 --batch-size 10 --sleep 8.0 --captcha-skip

Giáº£i thÃ­ch tham sá»‘:
Tham sá»‘	Ã nghÄ©a
--limit	Sá»‘ báº£n ghi tá»‘i Ä‘a cáº§n xá»­ lÃ½ (0 = táº¥t cáº£)
--batch-size	Má»—i lÆ°á»£t Ä‘á»c bao nhiÃªu dÃ²ng tá»« DB
--sleep	Thá»i gian nghá»‰ giá»¯a cÃ¡c láº§n truy cáº­p (giÃ¢y)
--max-retries	Sá»‘ láº§n thá»­ láº¡i khi lá»—i
--captcha-skip	Bá» qua báº£n ghi náº¿u gáº·p CAPTCHA
VÃ­ dá»¥ khÃ¡c:
python fetch_gmaps_photos_selenium.py --limit 200 --batch-size 20 --sleep 2.0


â†’ nghÄ©a lÃ : xá»­ lÃ½ 200 dÃ²ng, má»—i batch 20, nghá»‰ 2 giÃ¢y giá»¯a cÃ¡c request.

ğŸ” 5. Giáº£i thÃ­ch logic trong code
1ï¸âƒ£ Káº¿t ná»‘i Database

HÃ m get_conn() Ä‘á»c config tá»« .env, táº¡o káº¿t ná»‘i PostgreSQL, báº­t autocommit, vÃ  Ä‘áº·t timeout Ä‘á»ƒ trÃ¡nh treo.

2ï¸âƒ£ Láº¥y dá»¯ liá»‡u cáº§n cáº­p nháº­t
SELECT id, place_id FROM grocery_stores
WHERE image IS NULL OR image = '' OR image = 'N/A';


â†’ chá»‰ láº¥y nhá»¯ng báº£n ghi chÆ°a cÃ³ áº£nh.

3ï¸âƒ£ Má»Ÿ Google Maps

DÃ¹ng Selenium (undetected Chrome) Ä‘á»ƒ truy cáº­p:

https://www.google.com/maps/place/?q=place_id:<mÃ£>


â†’ Giá»‘ng nhÆ° báº¡n gÃµ link vÃ o Chrome tháº­t.

4ï¸âƒ£ TrÃ­ch xuáº¥t áº£nh

Script cá»‘ gáº¯ng láº¥y áº£nh theo thá»© tá»±:

Tháº» meta og:image â†’ nhanh nháº¥t

Náº¿u khÃ´ng cÃ³, click áº£nh header cá»§a trang Google Maps

Cuá»‘i cÃ¹ng, regex quÃ©t toÃ n bá»™ HTML Ä‘á»ƒ tÃ¬m áº£nh chá»©a googleusercontent.com

5ï¸âƒ£ Cáº­p nháº­t Database

Gá»i hÃ m update_image() Ä‘á»ƒ ghi áº£nh vÃ o cá»™t image.
CÃ³ kiá»ƒm tra lock & retry an toÃ n, khÃ´ng bá»‹ deadlock.

6ï¸âƒ£ CÆ¡ cháº¿ chá»‘ng bá»‹ cháº·n

ThÃªm time.sleep() ngáº«u nhiÃªn sau má»—i láº§n táº£i trang.

CÃ³ thá»ƒ cháº¡y headless Ä‘á»ƒ tiáº¿t kiá»‡m tÃ i nguyÃªn.

Náº¿u gáº·p CAPTCHA, script cÃ³ thá»ƒ nghá»‰ táº¡m hoáº·c bá» qua báº£n ghi tÃ¹y tuá»³ chá»n --captcha-skip.

ğŸ§° 6. Váº­n hÃ nh & kinh nghiá»‡m thá»±c táº¿
TÃ¬nh huá»‘ng	Giáº£i phÃ¡p
Bá»‹ CAPTCHA liÃªn tá»¥c	TÄƒng --sleep, giáº£m --batch-size, hoáº·c dÃ¹ng proxy
áº¢nh khÃ´ng láº¥y Ä‘Æ°á»£c	CÃ³ thá»ƒ do Google Ä‘á»•i giao diá»‡n â€“ cáº§n chá»‰nh láº¡i CSS selector
DB bá»‹ káº¹t	Äáº£m báº£o dÃ¹ng autocommit vÃ  FOR UPDATE NOWAIT
Muá»‘n test	DÃ¹ng --dry-run Ä‘á»ƒ chá»‰ in log mÃ  khÃ´ng cáº­p nháº­t DB
Cháº¡y nhiá»u mÃ¡y song song	Chia dá»¯ liá»‡u theo id hoáº·c province Ä‘á»ƒ trÃ¡nh trÃ¹ng
ğŸ“Š 7. Minh há»a quy trÃ¬nh hoáº¡t Ä‘á»™ng
flowchart TD
A[Start Script] --> B[Káº¿t ná»‘i PostgreSQL]
B --> C[Láº¥y batch cá»­a hÃ ng cáº§n áº£nh]
C --> D[Má»Ÿ Google Maps qua Selenium]
D --> E[PhÃ¡t hiá»‡n CAPTCHA?]
E -->|CÃ³| F[Nghá»‰ táº¡m / Äá»•i proxy / Bá» qua]
E -->|KhÃ´ng| G[Láº¥y áº£nh tá»« og:image hoáº·c HTML]
G --> H[Cáº­p nháº­t cá»™t image trong DB]
H --> I[Xá»­ lÃ½ batch tiáº¿p theo]
I -->|Háº¿t dá»¯ liá»‡u| J[HoÃ n táº¥t]

âœ… 8. Káº¿t luáº­n

Script fetch_gmaps_photos_selenium.py lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ giÃºp:

Tá»± Ä‘á»™ng Ä‘iá»n áº£nh Ä‘áº¡i diá»‡n cho cá»­a hÃ ng tá»« Google Maps.

KhÃ´ng tá»‘n chi phÃ­ API.

CÃ³ cÆ¡ cháº¿ chá»‘ng lá»—i, retry, chá»‘ng CAPTCHA, vÃ  ghi log chi tiáº¿t.

Tuy nhiÃªn, báº¡n cáº§n:

TuÃ¢n thá»§ Ä‘iá»u khoáº£n dá»‹ch vá»¥ cá»§a Google.

Giá»›i háº¡n tá»‘c Ä‘á»™ truy cáº­p.

Cháº¡y thá»­ trÆ°á»›c trÃªn dataset nhá» Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n.

ğŸ¤ Gá»£i Ã½ trÃ¬nh bÃ y khi bÃ¡o cÃ¡o:

â€œScript cá»§a nhÃ³m em sá»­ dá»¥ng Selenium Ä‘á»ƒ tá»± Ä‘á»™ng láº¥y áº£nh Google Maps cho cÃ¡c cá»­a hÃ ng.
QuÃ¡ trÃ¬nh gá»“m 5 bÆ°á»›c: láº¥y dá»¯ liá»‡u chÆ°a cÃ³ áº£nh, má»Ÿ trang Maps báº±ng Chrome tá»± Ä‘á»™ng, trÃ­ch xuáº¥t áº£nh, cáº­p nháº­t vÃ o PostgreSQL, vÃ  láº·p láº¡i cho Ä‘áº¿n khi hoÃ n táº¥t.
Nhá» Ä‘Ã³, dá»¯ liá»‡u trong báº£ng grocery_stores trá»Ÿ nÃªn Ä‘áº§y Ä‘á»§ hÆ¡n, phá»¥c vá»¥ tá»‘t cho viá»‡c hiá»ƒn thá»‹ báº£n Ä‘á»“ nhÃ  thuá»‘c hoáº·c cá»­a hÃ ng.â€